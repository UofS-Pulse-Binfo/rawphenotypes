<?php
/**
 * @class
 * Purpose: Provide a quick search on entity pages which submits/redirects to a full search.
 *
 * Display: A simple textfield search form.
 * Configuration:
 *   - path to the full search.
 *   - the URL token (query parameter) the value applies to.
 *   - help text.
 *   - textfield placeholder.
 *   - search button text.
 *   - autocomplete path.
 */
class ncit__raw_data_formatter extends TripalFieldFormatter {
  // The default label for this field.
  public static $default_label = 'Germplasm Raw Phenotypes';

  // The list of field types for which this formatter is appropriate.
  public static $field_types = array('ncit__raw_data');

  /**
   *  Provides the display for a field
   *
   * This function corresponds to the hook_field_formatter_view()
   * function of the Drupal Field API.
   *
   *  This function provides the display for a field when it is viewed on
   *  the web page.  The content returned by the formatter should only include
   *  what is present in the $items[$delta]['values] array. This way, the
   *  contents that are displayed on the page, via webservices and downloaded
   *  into a CSV file will always be identical.  The view need not show all
   *  of the data in the 'values' array.
   *
   *  @param $element
   *  @param $entity_type
   *  @param $entity
   *  @param $langcode
   *  @param $items
   *  @param $display
   *
   *  @return
   *    An element array compatible with that returned by the
   *    hook_field_formatter_view() function.
   */
  public function view(&$element, $entity_type, $entity, $langcode, $items, $display) {
    // Only when germplasm has raw phenotypic data under experiment/s that user
    // has permission to access or export data. This value is an empty array when
    // user has neither permission nor active experiments.
    if ($items[0]['value']) {
      // All trait and experiment+location values are accessible through this var.
      $germplasm_raw_phenotypes = $items[0]['value']['hydra:member'];
      // Experiment array user has permission to.      
      $user_experiment = $items[0]['value']['phenotype_customfield_terms:user_experiment'];
      // Overall summary count of raw phenotypic data by experiment, location and trait.
      $summary_values = $items[0]['value']['phenotype_customfield_terms:summary'];
      // Id (stock id) of the current germplasm.
      $germplasm_id = $entity->chado_record->stock_id;
      // Name (stock name) of the current germplasm.
      $germplasm_name = $entity->chado_record->name;

      // Reference directory path.
      $base_path   = $GLOBALS['base_url'] . '/'; 
      $module_path = drupal_get_path('module', 'rawpheno') . '/';
      $theme_path  = $base_path . $module_path . '/includes/TripalFields/ncit__raw_data/theme/';
      
      // Append image as bullet points, header icon and export button or link.
      $img = '<img id="rawphenotypes-germplasm-field-trait-select-%s-img" src="%s" border="0" align="absmiddle" title="%s" />';
      

      // CONSTRUCT SUMMARY TABLE:
      // Each row will contain the trait name (trait header), location and experiment combination (LOCATION/Experiment header)
      // as a select box and download link (download icon header).

      // # TABLE HEADER:
      $table_header = array(
        sprintf($img, '', $theme_path . 'icon-download-all.jpg', 'Download all for this trait'), 
        'Trait', 
        'LOCATION + Experiment',
        sprintf($img, '', $theme_path . 'icon-download.jpg', 'Download Location + Experiment')
      );
      
      // # TABLE ROWS:
      $table_row = array();       
      foreach($germplasm_raw_phenotypes as $trait => $exp_loc) {
        $tmp = explode('_', $trait);
        $trait = array('id' => $tmp[1], 'name' => $tmp[0]);

        $table_row[] = array(
          sprintf($img, $trait['id'] . '-all', $theme_path . 'icon-export.png', 'Download all for this trait'),
          ucfirst($trait['name']), 
          $this->create_select($germplasm_id, $trait, $exp_loc, $user_experiment),
          sprintf($img, $trait['id'], $theme_path . 'icon-export.png', 'Download Location + Experiment')
        ); 
      }
      
      // # THEME TABLE:
      $summary_table = theme('table', array(
        'header' => $table_header, 
        'rows' => $table_row, 
        'sticky' => FALSE, 
        'attributes' => array('id' => 'rawphenotypes-germplasm-field-table'))
      );
      

      // Make field elements generated by formatter avaiable to the template as template vars.
      // @see template file for this field in rawphenotypes/theme directory.
      $markup = theme('rawpheno_germplasm_field', array(
        'element_id' => 'rawphenotypes-germplasm-raw-phenotypes-field',
        'summary_table' => array(
          'table' => $summary_table,
          'headers' => array(
            'germplasm'   => $germplasm_name,
            'experiments' => $summary_values['phenotype_customfield_terms:experiment'],   
            'locations'   => $summary_values['phenotype_customfield_terms:location'],
            'traits'      => $summary_values['phenotype_customfield_terms:trait'], 
          )
        )
      ));

      // Rawphenotypes download link:
      drupal_add_js(array('rawpheno' => array('exportLink' => $base_path . '/phenotypes/raw/download')), array('type' => 'setting'));
      // Autocomplete UI.
      drupal_add_library('system', 'ui.autocomplete');

      // Construct field render array.
      $element[0] = array(
        '#type' => 'markup',
        '#markup' => $markup,
        '#attached' => array(
          'css' => array($module_path . 'theme/css/rawpheno.germplasmfield.style.css'),
          'js'  => array($module_path . 'theme/js/rawpheno.germplasmfield.script.js')
        )
      );      
    }

    return $element;
  }
  
  /**
   * Create select field.
   * 
   * @param $germplasm
   *   Stock id number.
   * @param $trait
   *   Associative array, with keys id and name that represent
   *   the cvterm id and cvterm name of a trait respectively.
   * @param $experiment
   *   An array containing all experiment the trait+germplasm 
   *   was measured with location information besides the experiment.
   * @param $user_experiment
   *   Array of experiments user has access to. This will be used to cross check
   *   if experiment should be enabled or disabled to a user.
   */
  public function create_select($germplasm, $trait, $experiment, $user_experiment) {
    // Array to hold select option for select field by location + experiment.
    $option_loc_exp = array();
    // Array to hold select option for select field by experiment.
    $option_exp = array();
    // Array to hold sorted values for select field by experiment.
    $experiments = array();
    // Store all experiments.
    $cache_exp = array();
    
    // Create select by location + experiment at the same time
    // prepare values for the other select (by experiment).
    foreach($experiment as $exp_loc) {
      $experiment_name = $exp_loc['phenotype_customfield_terms:name'];
      $experiment_id   = $exp_loc['phenotype_customfield_terms:id'];
      $experiment_loc  = $exp_loc['phenotype_customfield_terms:location'];
      
      $disabled = (in_array($experiment_id, $user_experiment)) ? '' : 'disabled';
      
      // Select by Experiment.
      if (!in_array($experiment_id, $cache_exp)) {
        $experiments[ $experiment_id ] = array(
          'disabled' => $disabled, 
          'text' => $experiment_name,
          'value' => $trait['id'] . '#' . $experiment_id . '#' . $germplasm . '#'
        );  
      }

      $experiments[ $experiment_id ]['locations'][] = $experiment_loc;
      $cache_exp[] = $experiment_id;
      
      // Select by Location + Experiment.
      $select_value = $trait['id'] . '#' . $experiment_id . '#' . $germplasm . '#' . $experiment_loc;
      $option_loc_exp[] = '<option value ="' . $select_value . '" ' . $disabled . '>' . strtoupper($experiment_loc) . '/' . $experiment_name . '</option>';
    }

    $select_location_experiment = '<select class="form-select" id="rawphenotypes-germplasm-field-trait-select-location-experiment-' . $trait['id'] . '">
    <option value="0" selected>Select (' . count($experiment) . ' Locations, ' . count(array_unique($cache_exp)) . ' Experiments)</option>
    %s
    </select>';


    // Construct select by experiment.
    foreach($experiments as $experiment) {
      $locations = implode('+', $experiment['locations']);
      $select_value = $experiment['value'] . $locations;
      
      $option_exp[] = '<option value ="' . $select_value . '" ' . $experiment['disabled'] . '>' . $experiment['text'] . ' (' . count($experiment['locations']). ')' . '</option>';      
    }

    $select_experiment = '<select class="form-select" id="rawphenotypes-germplasm-field-trait-select-experiment-' . $trait['id'] . '">
    <option value="0" selected>Select (' . count($experiments) . ' Experiments)</option>
    %s
    </select>';

    return sprintf($select_location_experiment, implode('', $option_loc_exp)) . sprintf($select_experiment, implode('', $option_exp));
  }
}


/**
 
foreach($experiment as $exp_loc) {
      $experiment_name = $exp_loc['phenotype_customfield_terms:name'];
      $experiment_id   = $exp_loc['phenotype_customfield_terms:id'];
      $experiment_loc  = $exp_loc['phenotype_customfield_terms:location'];

      $select_value = $trait['id'] . '#' . $experiment_id . '#' . $experiment_loc . '#' . $germplasm;
      $cache_exp[] = $experiment_id;

      $disabled = (in_array($experiment_id, $user_experiment)) ? '' : 'disabled';
      $option_loc_exp[] = '<option value ="' . $select_value . '" ' . $disabled . '>' . strtoupper($experiment_loc) . '/' . $experiment_name . '</option>';
      
      
    
    
    }




 * 
 */