<?php

/**
 * @file
 * The main functionality for this module.
 * Credits to: 
 *   http://jamesdavidson.io/blog/how-create-multi-step-form-drupal-7
 *   https://github.com/nuovo/spreadsheet-reader
 *   http://www.d3js.org
 */

<<<<<<< HEAD
// Include function to manage column headers.
module_load_include('inc', 'rawpheno', 'include/rawpheno.function.measurements');
=======
// Include functions required in processing spreadsheet file.
module_load_include('inc', 'rawpheno', 'include/rawpheno.upload.excel');
module_load_include('inc', 'rawpheno', 'include/rawpheno.validation');
module_load_include('inc', 'rawpheno', 'include/rawpheno.upload.form');
>>>>>>> origin/master

/**
 * Implements hook_menu().
 */
function rawpheno_menu() {
  // The following menu items will default in Navigation menu block.
  // RAW DATA
  //  - DOWNLOAD DATA
  //  - INSTRUCTIONS
  //  - UPLOAD DATA
  
  // RAW DATA PAGE
  // A summary page of the raw data currently available.
  $items['phenotypes/raw'] = array(
    'title' => 'Raw Data',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rawpheno_rawdata'),
    'access arguments' => array('access content'),
    'file' => 'include/rawpheno.rawdata.form.inc',
    'type' => MENU_NORMAL_ITEM,
  );
    // Menu callback which generates the summary data in JSON,
    // required by the heat map in rawdata page.
    $items['rawdata'] = array(
      'page callback' => 'rawpheno_rawdata_summary_json', 
      'access callback' => true, 
      'delivery callback' => 'drupal_json_output',
      'type' => MENU_CALLBACK,
    );
  
  // INSTRUCTIONS PAGE
  // A page containing standard phenotyping procedure and
  // providing data collection spreadsheet.
  $items['phenotypes/raw/instructions'] = array(
    'title' => 'Instructions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rawpheno_instructions'),
    'access arguments' => array('access content'),
    'file' => 'include/rawpheno.instructions.form.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 0,
  );
    // Menu callback which generates a list of headers in JSON,
    // used to autocomplete a search field and process search action
    // in instructions page.
    $items['autocomplete'] = array(
      'page callback' => 'rawpheno_instructions_autocomplete_search',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );
  
  // DOWNLOADS PAGE
  // A page providing export data options.
  $items['phenotypes/raw/download'] = array(
    'title' => 'Download Data',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rawpheno_download'),
    'access arguments' => array('access content'),
    'file' => 'include/rawpheno.download.form.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 6,
  );
    
  // DRAG AND DROP UPLOAD PAGE
  // A page for uploading and validating data collection spreadsheet.
  $items['phenotypes/raw/upload'] = array(
    'title' => 'Upload Data',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rawpheno_upload_form_master'),
    'access arguments' => array('access content'),
	  'file' => 'include/rawpheno.upload.form.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 3,
  );
  
  // ADMIN COLOUR SETTINGS PAGE
  // A page for changing page colour and page title.
  $items['admin/config/user-interface/rawpheno_testadmin'] = array(
    'title' => 'Rawpheno Page Configurations',
    'description' => 'Apply a colour scheme and change page title.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rawpheno_colourscheme'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );
  
  return $items;
}

/**
 * Function callback: construct settings form to change colour scheme and page title.
 */
function rawpheno_colourscheme($form, &$form_state) {
  $form['rawpheno_colour_scheme'] = array(
    '#type' => 'textfield',
    '#title' => t('Enter colour:'),
    '#default_value' => variable_get('rawpheno_colour_scheme'),
    '#size' => 40,
    '#maxlength' => 20,
    '#description' => t('eg. HEX: #304356, blue | <a href="@adobe-kuler" target="_blank">get more colours here</a>', 
                        array('@adobe-kuler' => url('https://color.adobe.com/'))),
    '#required' => TRUE,
  );
  
  // Headers and title
  $form['fieldset'] = array(
    '#type' => 'fieldset',
    '#title' => t('Page title'),
    '#collapsed' => FALSE,
  );
    
    // Rawdata page.
    $form['fieldset']['rawpheno_rawdata_title'] = array(
      '#type' => 'textfield',
      '#title' => t('Title of Rawdata page:'),
      '#default_value' => variable_get('rawpheno_rawdata_title'),
      '#size' => 120,
      '#maxlength' => 220,
      '#required' => TRUE,
    );
    
    // Download Page.
    $form['fieldset']['rawpheno_download_title'] = array(
      '#type' => 'textfield',
      '#title' => t('Title of Download page:'),
      '#default_value' => variable_get('rawpheno_download_title'),
      '#size' => 120,
      '#maxlength' => 220,
      '#required' => TRUE,
    );  
    
    // Instructions page.
    $form['fieldset']['rawpheno_instructions_title'] = array(
      '#type' => 'textfield',
      '#title' => t('Title of Instructions page:'),
      '#default_value' => variable_get('rawpheno_instructions_title'),
      '#size' => 120,
      '#maxlength' => 220,
      '#required' => TRUE,
    );  
  
    // Upload page.
    $form['fieldset']['rawpheno_upload_title'] = array(
      '#type' => 'textfield',
      '#title' => t('Title of Upload page:'),
      '#default_value' => variable_get('rawpheno_upload_title'),
      '#size' => 120,
      '#maxlength' => 220,
      '#required' => TRUE,
    );  
  
  return system_settings_form($form);
}

/**
 * Implements hook_preprocess().
 */
function rawpheno_preprocess(&$variables) {
  // Path to module.
  $variables['path'] = drupal_get_path('module', 'rawpheno');
  // Phenotyping traits present in standard phenotyping procedure.
  $variables['traits'] = rawpheno_function_headers('phenotyping'); 
  
  // Colour scheme selected by the user from the admin/configuration.
  $colour = variable_get('rawpheno_colour_scheme');
  // Default to navy blue of knowpulse if no colour is provided.
  // This colour will fill background of header and top right button, and border of content area.
  $theme_colour = (empty($colour)) ? '#304356' : $colour;
  $variables['theme_colour'] = $theme_colour;
  
  // URL to each page.
  $arr_url = array(
    'rawpheno_rawdata' => url('phenotypes/raw'),
    'rawpheno_download' => url('phenotypes/raw/download'),  
    'rawpheno_instructions' => url('phenotypes/raw/instructions'),
    'rawpheno_upload' => url('phenotypes/raw/upload')
  );
  
  // Cross-link page.
  // Rawdata and download page.
  // Instructions and upload page.
  $arr_assign_url = array(
    'rawpheno_rawdata' => $arr_url['rawpheno_download'],
    'rawpheno_download' => $arr_url['rawpheno_rawdata'],  
    'rawpheno_instructions' => $arr_url['rawpheno_upload'],
    'rawpheno_upload' => $arr_url['rawpheno_instructions']
  );
  
  $variables['rel_url'] = $arr_assign_url;
  
  // Page titles from admin configuration panel.
  $arr_headers = array();
  $arr_headers['rawpheno_rawdata'] = variable_get('rawpheno_rawdata_title');
  $arr_headers['rawpheno_download'] = variable_get('rawpheno_download_title');
  $arr_headers['rawpheno_instructions'] = variable_get('rawpheno_instructions_title');
  $arr_headers['rawpheno_upload'] = variable_get('rawpheno_upload_title');
  
  $variables['page_title'] = $arr_headers;
}

/**
 * Implements hook_theme().
 *
 * Returns HTML for rawpheno pages.
 */
function rawpheno_theme($existing, $type, $theme, $path) {
  // Rawdata page.
  $items['rawpheno_rawdata'] = array(
    'render element' => 'form',
    'template' => 'rawpheno_pages',
    'path' => $path . '/theme',
  );
  
  // Instructions page.
  $items['rawpheno_instructions'] = array(
    'render element' => 'form',
    'template' => 'rawpheno_pages',
    'path' => $path . '/theme',
  );
  
  // Download page.
  $items['rawpheno_download'] = array(
    'render element' => 'form',
    'template' => 'rawpheno_pages',
    'path' => $path . '/theme',
  );

  // Upload page.
  $items['rawpheno_upload_form_master'] = array(
    'render element' => 'form',
    'template' => 'rawpheno_pages',
    'path' => $path . '/theme',
  );
    // Upload Errors.
    $items['rawpheno_upload_validation_report'] = array(
      'template' => 'rawpheno_upload_validation_report',
      'path' => $path . '/theme',
    );
    
  return $items;
}

/**
 * Implements hook_libraries_info().
 *
 * Define external libraries: Spreadsheet Reader and D3JS
 */
function rawpheno_libraries_info() {
  // Spreadsheet reader
  // File option is empty since library files are included
  // individually using include_once().
  // files in: sites/all/libraries/spreadsheet-reader
  //   - SpreadsheetReader.php
  //   - SpreadsheetReaderXLSX.php
  //   - SpreadsheetReaderXLS.php
  //   - php-excel-reader/excel_reader2.php
  $libraries['spreadsheet_reader'] = array(
    'name' => 'NUOVO Spreadsheet',
    'vendor url' => 'https://github.com/nuovo/spreadsheet-reader',
    'download url' => 'https://github.com/nuovo/spreadsheet-reader',
    'path' => 'sites/all/libraries/spreadsheet-reader/',
    'files' => array(),
  );
  
  // D3 JavaScript.
  $libraries['d3'] = array(
    'name' => 'D3 Data-Driven Documents',
    'version' => '3.4.14',
    'vendor url' => 'https://d3js.org/',
    'download url' => 'https://github.com/mbostock/d3/releases/download/v3.5.14/d3.zip',
    'library path' => 'sites/all/libraries/',
    'path' => 'sites/all/libraries/d3/',
    'files' => array(
      'js' => array('d3.js')
    )
  );
  
  return $libraries;
}

/**
 * Function callback: Autocomplete search field.
 *
 * @see hook_menu()
 * 
 * @param $key
 *   A string containing the search keywords entered in the search field.
 *
 * @return 
 *   A JSON where each trait is both the key and the value. The key is what is 
 *   sent to JavaScript processing the search, while the value is what is suggested
 *   to user while typing in the seach field.
 */
function rawpheno_instructions_autocomplete_search($key = '') {
  // Array to hold list of traits.
  $arr_headers = array();
  // Array of column headers available in standard phenotyping instructions page.
  $arr_phenotyping_headers = rawpheno_function_headers('phenotyping');

  // Determine if keyword is provided.
  if (empty($key)) {
    // No keywords - Return all headers for JavaScript processing the search.
    $arr_headers = array_values($arr_phenotyping_headers);
  }
  else {
    // With keywords - Select only the headers with keywords in it.
    // These headers will then be suggested to the user as they type keywords.
    foreach($arr_phenotyping_headers as $index => $header) {
      if (stristr($header, $key)) {
        $arr_headers[$header] = $header;
      } 
    } 
  }
 
  drupal_json_output($arr_headers);
}

/**
 * Function callback: Generate data for the heat map.
 *
 * @see hook_menu()
 *
 * @return
 *   A JSON and each member has the following objects:
 *   location, year, rep, # traits.
 */
function rawpheno_rawdata_summary_json() {
  // Get the cvterm_id of planting date trait.
  // The id will be used to determine if planting date is present in the list of headers. 
  // The final trait count will be deducted by 1 if planting date is present.
  $planting_date = tripal_get_cvterm(array('name' => 'planting_date'))
                   ->cvterm_id; 
  
  // Select all locations from materialized view.
  $sql = "SELECT DISTINCT location 
    FROM {chado.rawpheno_rawdata_mview} 
    ORDER BY location ASC";
  $locations = db_query($sql);
  
  if ($locations) {
    // Array to hold the JSON.
    $arr_json = array();
    // Array of planting years.
    $arr_year = array(2017, 2016, 2015);
    // Array of rep per year.
    $arr_rep = array(1, 2, 3);

    // Data set format per location.
    // location x - year 1 - rep 1 - # traits
    // location x - year 1 - rep 2 - # traits
    // location x - year 1 - rep 3 - # traits
    // location x - year 2 - rep 1 - # traits
    // location x - year 2 - rep 2 - # traits
    // location x - year 2 - rep 3 - # traits
    // location x - year 3 - rep 1 - # traits
    // location x - year 3 - rep 2 - # traits
    // location x - year 3 - rep 3 - # traits
    
    // Read each location available and construct data set.
    while($data = $locations->fetchAssoc()) {
      // In each location, read each planting year.
      foreach($arr_year as $year) {
        // In each year, read each rep.
        foreach($arr_rep as $rep) {
          // Each location in the materialized view
          $location = $data['location'];
          
          // Get traits summary based on location, year and rep,
          // if none is found, gap is filled in for that particular year
          // and rep to ensure that by the end of this iteration, each location
          // has a total of 9 rows of data (3 reps X 3 planting years) - shown above.
          $sql = "SELECT measurement 
            FROM {chado.rawpheno_rawdata_mview}
            WHERE measurement LIKE :year
              AND rep = :rep 
              AND location = :location 
            LIMIT 1";  
          $traits = db_query($sql, array(':year' => '%'.$year.'%', 
                                         ':rep' => $rep, 
                                         ':location' => $location))
                    ->fetchField();

          if (isset($traits) && !empty($traits)) {
            // This particular year and rep have data collected.
            // Compute the total traits measured excluding planting date.
            $trait_count = 0;
            // From the materialized view: measurement field contains data
            // in the following format:
            // trait1 id=trait1 value:trait2 id=trait2 value:...
            $trait_summary = explode(':', $traits);
            
            // Read each trait id=trait value combination.
            foreach($trait_summary as $entry) {
              list($type_id, $value) = explode('=', $entry);
              //Count all traits except planting date.
              if ($type_id != $planting_date) {
                $trait_count++;
              }
            } 
          }
          else {
            // This particular year and rep have no data collected.
            $trait_count = 0;
          }
          
          // Create a json entry with the following keys:
          // location, year, rep and trait.
          $arr_json[] = array('location' => $location,
                              'year' => $year,
                              'rep' => $rep,
                              'trait' => $trait_count);
        }
      }
    }
  }
  
  return $arr_json;
}